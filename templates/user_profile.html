{% extends 'base.html' %}

{% block content %}
    <!-- Show basic user info -->
    <h1>{{ user_info.user.username }}'s Profile <h1>
    <h3>Email: {{ user_info.user.email }}</h3>

    <!-- Show mood logs -->
    <p>Mood logs:</p>
<!--     <h4><a href='/log_day_mood'>Add mood log for a day</a></h4> -->
    <h4><a href='/log_event_mood'>Add mood log for an event</a></h4>

    <!-- Day Log Mood Chart -->
    <div class="mood-chart" style='height: 50vh; width: 75vw'>
      <canvas id="moodChart"></canvas>
    <div>
    <br>

    <script>
        // Set options for chart.js mood chart 
        var options = { responsive: true,
                        maintainAspectRatio: false,
            // http://stackoverflow.com/questions/37061945/how-to-format-x-axis-time-scale-values-in-chart-js-v2
                        scales: {
                            xAxes: [{
                                type:'time',
                                unit: 'day',
                                unitStepSize: 1,
                                time: {
                                    displayFormats: {
                                        'day': 'MMM DD'
                                    },
                                min: '{{ user_info.day_log_range[0] }}',
                                max: '{{ user_info.day_log_range[1] }}'                                
                                } 
                            }]
                        }};
        // Select canvas for mood chart
        var ctx = $('#moodChart').get(0).getContext('2d');

        $( function() {
            $.get('/day_mood_chart.json', function (data) {
                // console.log(data);
                var moodChart = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: options
                });
            });
        });
    </script>

    <!-- Log Day Button trigger modal -->
    <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#day-log-modal">
      Log A New Day
    </button>

    <!-- Add Day Modal -->
    <div class="modal fade" id="day-log-modal" tabindex="-1" role="dialog" aria-labelledby="day-log-modal">
      <div class="modal-dialog" role="document">

        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="day-log-title">Log Day </h4>
          </div>
          <div class="modal-body">
            <form id='day-mood-form' action='/log_day_mood' method='POST'>
                <label for='date'>Date: </label>
                <input type="text" id="date" name="date" readonly="true" required><br>

                <label for='overall-mood'>Overall Mood: </label>
                <input id='overall-mood' type='number' name='overall-mood' min='-50' max='50' required><br>

                <p id='mood-range'>Range of Mood: 
                <label for='min-mood'>Min: </label>
                <input id='min-mood' type='number' name='min-mood' min='-50' max='50'>

                <label for='max-mood'>Max: </label>
                <input id='max-mood' type='number' name='max-mood' min='-50' max='50'>
                <span id="alert-msg" style='color:red;'></span><br>
                </p>

                <label for='notes'>Notes About This Day:</label>
                <input id='notes' type='textarea' name='notes'><br>

                <input type='submit' value='Add Day Mood Log'>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- js for Add Day Log form -->
    <script src='static/datepicker.js'></script>
    <script>
        var datepickerId = '#date';
        // Get list of dates to exclude from datepicker
        // |safe allows the python list to become a js array (if not the '[]' become something else)
        var excludeDates = {{ user_info.logged_days|safe }};

        $( function() {
            createDatepicker(datepickerId);
            excludeLoggedDays(datepickerId, excludeDates);
            $('#day-mood-form').on('submit', validateMoodRange);
        });
    </script>         

    <!-- Show prescription logs -->
    <h3>Prescriptions:</h3>
    <h4><a href='/drugs'>Add prescription from drug list</a></h4>

    <ul>
        {% for drug, prescription_list in user_info.prescriptions.items() %}
        <li>
            <b>{{ drug }}</b>
            <ul>
                {% for prescription in prescription_list %}
                <li>
                    <a href='prescription_info/{{ prescription.prescription_id }}'>
                        Dosage: {{ prescription.dosage }},
                        Frequency: {{ prescription.frequency }}
                    </a>
                    <!-- Notes whether prescription is active -->
                    {% if not prescription.end_date %}[ ACTIVE ]{% endif %}
                </li>
                {% endfor %}
            </ul>
        </li>
        {% endfor %}
    </ul>


{% endblock %}    